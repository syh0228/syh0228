---
title: 'Business Statistics Mid-Term Assessment IB94X0 2022-2023 #2'
author: '2217519'
output:
  html_document:
    toc: yes
    toc_depth: 3
---

---

This is to certify that the work I am submitting is my own. All external references and sources are clearly acknowledge and identified within the contents. I am aware of the University of Warwick regulation concerning plagiarism and collusion.

No substantial part(s) of the work submitted here has also been submitted by me in other assessments for accredited courses of study, and I acknowledge that if this has been done an appropriate reduction in the mark I might otherwise have received will be made.

---

```{r setup}
library(tidyverse)
library(grid)
library(gridExtra)
library(Hmisc)
library(emmeans)
library(car)
options(width=100)
```

---

# Question 1

## Data Dictionary

Variables              | Description |
-----------------------|-------------|
LA Type |Type of Local Authority|  
LA Name |Name of Local Authority| 
Total establishments(including not yet rated & outside) |Total number of food business registered (or approved) by LAs| 
Establishments not yet rated for intervention |Establishments such as new businesses yet to be assessed and rated for risk for food hygiene| 
Establishments outside the programme |Primary producers that food hygiene inspections and food standards inspections are currently not part of the planned intervention programme, as determined in accordance with the FLCoP| 
Total % of Broadly Compliant establishments rated A-E |Total % of establishments that has food hygiene rating of 3 (generally satisfactory) or above|
Total % of Broadly Compliant establishments (including not yet rated)|As above including not yet rated (NYR) establishment|
A rated establishments|Number of establishments that requires intervention frequency of at least every 6 months|
Total % of Broadly Compliant establishments - A|Total % of A rated establishments that is broadly compliant|
B rated establishments|Number of establishments that requires intervention frequency of at least every 12 months|
Total % of Broadly Compliant establishments - B|Total % of B rated establishments that is broadly compliant|
C rated establishments|Number of establishments that requires intervention frequency of at least every 18 months|
Total % of Broadly Compliant establishments - C|Total % of C rated establishments that is broadly compliant|
D rated establishments|Number of establishments that requires intervention frequency of at least every 24 months|
Total % of Broadly Compliant establishments - D|Total % of D rated establishments that is broadly compliant|
E rated establishments|Number of establishments that requires intervention frequency of every 3 years|
Total % of Broadly Compliant establishments - E|Total % of E rated establishments that is broadly compliant|
Total % of Interventions achieved (premises rated A-E)|Total % of food hygiene due interventions at premises rated A - E|
Total % of Interventions achieved - premises rated A|Total % of food hygiene due interventions at premises rated A (Premises rated ‘A’ are the highest risk premises)|
Total % of Interventions achieved - premises rated B|Total % of food hygiene due interventions at premises rated B|
Total % of Interventions achieved - premises rated C|Total % of food hygiene due interventions at premises rated C|
Total % of Interventions achieved - premises rated D|Total % of food hygiene due interventions at premises rated D|
Total % of Interventions achieved - premises rated E|Total % of food hygiene due interventions at premises rated E|
Total % of Interventions achieved - premises not yet rated|Total % of food hygiene due interventions at premises not yet rated|
Total number of establishments subject to formal enforcement actions - Voluntary closure|Total number of enforcement actions include all voluntary closures|
Total number of establishments subject to formal enforcement actions - Seizure, detention & surrender of food|Total number of enforcement actions include seizure, detention and surrender of food|
Total number of establishments subject to formal enforcement actions - Suspension/revocation of approval or licence|Total number of enforcement actions include suspension or revocation licence|
Total number of establishments subject to formal enforcement actions - Hygiene emergency prohibition notice|Total number of enforcement actions with hygiene emergency notice|
Total number of establishments subject to formal enforcement actions - Prohibition order|Total number of enforcement actions with prohibition order|
Total number of establishments subject to formal enforcement actions - Simple caution|Total number of enforcement actions with simple caution|
Total number of establishments subject to formal enforcement actions - Hygiene improvement notices|Total number of enforcement actions with hygiene improvement notice|
Total number of establishments subject to formal enforcement actions - Remedial action & detention notices|Total number of enforcement actions with remedial action and detention notice|
Total number of establishments subject to Written warnings|Total number of enforcement actions with written warning|
Total number of establishments subject to formal enforcement actions - Prosecutions concluded|Total number of enforcement actions include all prosecutions|
Professional Full Time Equivalent Posts - occupied *|Educated estimates of actual proportion of time spent by professional staff on food hygiene issues|

## Section 1

```{r}
# Read the dataset
enforcement <- read_csv("2019-20-enforcement-data-food-hygiene.csv")

# Check the structure
str(enforcement)
```

```{r}
# Clean data and store in another dataframe
enforcement <- na.omit(enforcement)

# Change data type
column_f <- c("Country", "LAType")
enforcement[column_f] <- lapply(enforcement[column_f], as.factor)

column_n <- c("Total%ofBroadlyCompliantestablishments-A", "Total%ofInterventionsachieved-premisesratedA", "TotalnumberofestablishmentssubjecttoWrittenwarnings")
suppressWarnings(enforcement[column_n] <- lapply(enforcement[column_n], as.numeric))

#Check the structure again
str(enforcement)
```

### The distribution across the Local Authorities of the percentage of enforcement actions successfully achieved.
```{r}
# Create a plot of the distribution of successful enforcement percentage
ggplot(enforcement, aes(x = `Total%ofInterventionsachieved(premisesratedA-E)`)) +
  geom_histogram(fill = "darkgrey", breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), na.rm = TRUE) + 
  labs(title='The Distribution of the Percentage of Successful Enforcement Actions', x='Percentage of Successful Actions', y='Count') +
  theme(plot.title = element_text(hjust=0.5)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100)) 
```

###  The distribution across the Local Authorities of the percentage of estabilishment rated A, B, C, D and E.
```{r}
# Create a plot of the distribution of establishment A
establishment_a <- ggplot(enforcement, aes(x = `Total%ofInterventionsachieved-premisesratedA`)) +
  geom_histogram(fill = "lightcoral", breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), na.rm = TRUE) + 
  labs(title='The Distribution of % of Establishment A ', x='Percentage of Successful Actions', y='Count') +
  theme(plot.title = element_text(hjust=0.5, size=8), axis.title.x = element_text(size=7), axis.title.y = element_text(size=7), axis.text = element_text(size = 7)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))

# Create a plot of the distribution of establishment B
establishment_b <- ggplot(enforcement, aes(x = `Total%ofInterventionsachieved-premisesratedB`)) +
  geom_histogram(fill = "lightskyblue", breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), na.rm = TRUE) +
  labs(title='The Distribution of % of Establishment B', x='Percentage of Successful Actions', y='Count') +
  theme(plot.title = element_text(hjust=0.5, size=8), axis.title.x = element_text(size=7), axis.title.y = element_text(size=7), axis.text = element_text(size = 7)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))

# Create a plot of the distribution of establishment C
establishment_c <- ggplot(enforcement, aes(x = `Total%ofInterventionsachieved-premisesratedC`)) +
  geom_histogram(fill = "palegreen2", breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), na.rm = TRUE) + 
  labs(title='The Distribution of % of Establishment C', x='Percentage of Successful Actions', y='Count') +
  theme(plot.title = element_text(hjust=0.5, size=8), axis.title.x = element_text(size=7), axis.title.y = element_text(size=7), axis.text = element_text(size = 7)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))

# Create a plot of the distribution of establishment D
establishment_d <- ggplot(enforcement, aes(x = `Total%ofInterventionsachieved-premisesratedD`)) +
  geom_histogram(fill = "goldenrod2", breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), na.rm = TRUE) + 
  labs(title='The Distribution of % of Establishment D', x='Percentage of Successful Actions', y='Count') +
  theme(plot.title = element_text(hjust=0.5, size=8), axis.title.x = element_text(size=7), axis.title.y = element_text(size=7), axis.text = element_text(size = 7)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))

# Create a plot of the distribution of establishment E
establishment_e <- ggplot(enforcement, aes(x = `Total%ofInterventionsachieved-premisesratedE`)) +
  geom_histogram(fill = "mediumpurple1", breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), na.rm = TRUE) + 
  labs(title='The Distribution of % of Establishment E', x='Percentage of Successful Actions', y='Count') +
  theme(plot.title = element_text(hjust=0.5, size=8), axis.title.x = element_text(size=7), axis.title.y = element_text(size=7), axis.text = element_text(size = 7)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))

# Layout all plots on a page
grid.arrange(establishment_a, establishment_b, establishment_c, establishment_d, establishment_e, nrow = 3)

```

### Examine whether there is a relationship between proportion of successful responses and the number of FTE food safety employees in each local authority. 
```{r}
# Make a tibble that only includes target variables
percent_fte <- as_tibble(list(percentage_of_responses = enforcement$`Total%ofInterventionsachieved(premisesratedA-E)`, fte_numbers = enforcement$`ProfessionalFullTimeEquivalentPosts-occupied *`))

# Calculate correlation
rcorr(as.matrix(percent_fte))

```

```{r}
# Visualise to check the relationship
ggplot(percent_fte, aes(x=percentage_of_responses, y = fte_numbers)) + geom_point() + labs(x="Percentage of Successful Responses", y="The Number of FTE Food Safety Employees", title='The relatioinship between the FTE food safety employee numbers and successful actions percentage.', subtitle="Each point is a Local Authority. The shaded area shows the 95% CI for the best-fitting regression line") + geom_smooth(formula = y ~ x, method=lm)
```

```{r}
#Calculate regression coefficient
prop.success.by.fte <- lm(percentage_of_responses ~ fte_numbers, data = percent_fte)
summary(prop.success.by.fte)
```

```{r}
#Compare a model of the proportion of successful responses with and without FTE food safety employees
anova(prop.success.by.fte)
```

```{r}
#Calculate regression coefficient using estimation approach
cbind(coefficient=coef(prop.success.by.fte), confint(prop.success.by.fte))
```


### Examine whether there is a relationship between proportion of successful responses and the number of employees as a proportion of the number of establishments in the local authority.
```{r}
# Add a new column to calculate the employee proportion of the number of establishments
enforcement <- enforcement %>%
  mutate(prop_employee = `ProfessionalFullTimeEquivalentPosts-occupied *` / `Totalestablishments(includingnotyetrated&outside)` * 100)
```

```{r}
# Make a tibble that only includes target variables
percent_prop_employee <- as_tibble(list(percentage_of_responses = enforcement$`Total%ofInterventionsachieved(premisesratedA-E)`, prop_employee = enforcement$prop_employee))

# Calculate correlation
rcorr(as.matrix(percent_prop_employee), type = "spearman")
```

```{r}
# Visualise to check the relationship
ggplot(percent_prop_employee, aes(x=percentage_of_responses, y = prop_employee)) + geom_point() + labs(x="Percentage of Successful Responses", y="Proportion of FTE Food Safety Employees", title='The relatioinship between the proportion of employee numbers in each establishment and successful actions percentage.', subtitle="Each point is a Local Authority. The shaded area shows the 95% CI for the best-fitting regression line") + geom_smooth(formula = y ~ x, method=lm)
```

```{r}
#Calculate regression coefficient
prop.success.by.prop.employee <- lm(percentage_of_responses ~ prop_employee, data = percent_prop_employee)
summary(prop.success.by.prop.employee)
```

```{r}
#Compare a model of the proportion of successful responses with and without FTE food safety employees
anova(prop.success.by.prop.employee)
```

```{r}
#Calculate regression coefficient using estimation approach
cbind(coefficient=coef(prop.success.by.prop.employee), confint(prop.success.by.prop.employee))
```

---

## Section 2

This report focuses on the statistical analysis on the intervention performance and presents the results requested by politicians and managers of the Food Standards Agency. In this report, we especially look into the distribution of the intervention performance and explore the relationship between the successful responses and food safety employees. The data used in this analysis is collected by the Food Standard Agency across three areas and expected to proviide some insights to enhance the action performance.

First of all, the following charts (Figure 1 and 2) displays the distribution of the percentage of enforcement actions successfully achieved. From the figure 1, we can see there are over 150 local authorities achieving 90%-100% in their successful responses rate and the cases in this percentage group account for over half (54%) of total local authorities.

```{r, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Figure 1. The distribution across the Local Authorities of the successful actions percentage."}
# Create a plot of the distribution of successful enforcement percentage
ggplot(enforcement, aes(x = `Total%ofInterventionsachieved(premisesratedA-E)`)) +
  geom_histogram(fill = "darkgrey", breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), na.rm = TRUE) + 
  labs(title='The Distribution of the Percentage of Successful Enforcement Actions', x='Percentage of Successful Actions', y='Count') +
  theme(plot.title = element_text(hjust=0.5)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100)) 
```

Going deeper to the distribution, we evaluate these local authorities' potential impacts on public health by grades A to E from the greatest to the lowest. The figure 2 shows the distribution of successful responses rate of each establishment rated from A to E. In the A-rated and B-rated establishments, almost all local authorities can reach between 90% and 100% in their successful responses rates, while over 70% of local authorities in the C-rated establishments are classified between 90% to 100%. By contrast, we can see the approximate half of local authorities in the establishments D and E concentrate in the highest percentage group (90%-100%).

```{r, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Figure 2. The distribution across the Local Authorities of the successful actions percentage by grades."}
# Create a plot of the distribution of establishment A
establishment_a <- ggplot(enforcement, aes(x = `Total%ofInterventionsachieved-premisesratedA`)) +
  geom_histogram(fill = "lightcoral", breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), na.rm = TRUE) + 
  labs(title='The Distribution of % of Establishment A ', x='Percentage of Successful Actions', y='Count') +
  theme(plot.title = element_text(hjust=0.5, size=8), axis.title.x = element_text(size=7), axis.title.y = element_text(size=7), axis.text = element_text(size = 7)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))

# Create a plot of the distribution of establishment B
establishment_b <- ggplot(enforcement, aes(x = `Total%ofInterventionsachieved-premisesratedB`)) +
  geom_histogram(fill = "lightskyblue", breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), na.rm = TRUE) +
  labs(title='The Distribution of % of Establishment B', x='Percentage of Successful Actions', y='Count') +
  theme(plot.title = element_text(hjust=0.5, size=8), axis.title.x = element_text(size=7), axis.title.y = element_text(size=7), axis.text = element_text(size = 7)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))

# Create a plot of the distribution of establishment C
establishment_c <- ggplot(enforcement, aes(x = `Total%ofInterventionsachieved-premisesratedC`)) +
  geom_histogram(fill = "palegreen2", breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), na.rm = TRUE) + 
  labs(title='The Distribution of % of Establishment C', x='Percentage of Successful Actions', y='Count') +
  theme(plot.title = element_text(hjust=0.5, size=8), axis.title.x = element_text(size=7), axis.title.y = element_text(size=7), axis.text = element_text(size = 7)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))

# Create a plot of the distribution of establishment D
establishment_d <- ggplot(enforcement, aes(x = `Total%ofInterventionsachieved-premisesratedD`)) +
  geom_histogram(fill = "goldenrod2", breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), na.rm = TRUE) + 
  labs(title='The Distribution of % of Establishment D', x='Percentage of Successful Actions', y='Count') +
  theme(plot.title = element_text(hjust=0.5, size=8), axis.title.x = element_text(size=7), axis.title.y = element_text(size=7), axis.text = element_text(size = 7)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))

# Create a plot of the distribution of establishment E
establishment_e <- ggplot(enforcement, aes(x = `Total%ofInterventionsachieved-premisesratedE`)) +
  geom_histogram(fill = "mediumpurple1", breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), na.rm = TRUE) + 
  labs(title='The Distribution of % of Establishment E', x='Percentage of Successful Actions', y='Count') +
  theme(plot.title = element_text(hjust=0.5, size=8), axis.title.x = element_text(size=7), axis.title.y = element_text(size=7), axis.text = element_text(size = 7)) +
  scale_x_continuous(breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100))

# Layout all plots on a page
grid.arrange(establishment_a, establishment_b, establishment_c, establishment_d, establishment_e, nrow = 3)
```

Next, we focus on the numbers of the FTE food safety employees and observe its impact on the likelihood of successful actions. As the figure 3, we find that the likelihood of successful responses demonstrates a slightly negative correlation (-0.02) with the number of the FTE food safety employees. As the employee numbers increase, these local authorities are less likely to successfully respond to enforcement actions.

```{r, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Figure 3. The relatioinship between the FTE food safety employee numbers and successful actions percentage."}
# Visualise to check the relationship
ggplot(percent_fte, aes(x=percentage_of_responses, y = fte_numbers)) + geom_point() + labs(x="Percentage of Successful Responses", y="The Number of FTE Food Safety Employees", title='The relatioinship between employee numbers and successful actions percentage.', subtitle="Each point is a Local Authority. The shaded area shows the 95% CI for the best-fitting regression line") + geom_smooth(formula = y ~ x, method=lm)
```

To look deeper into the relationship between these variables, the table 1 provides a detailed explanation. We can expect a 0.12 less likelihood of successful responses for every extra food safety employee. Meanwhile, we can also expect likelihood of 87.11 in successful responses rate when there is no employee.

Table 1. The relatoinship between the FTE food safety employee numbers and successful actions percentage.

```{r, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Table 1. The relatioinship between the FTE food safety employee numbers and successful actions percentage."}
#Calculate regression coefficient using estimation approach
cbind(coefficient=coef(prop.success.by.fte), confint(prop.success.by.fte))
```

Finally, we centre on the proportion between the employee numbers and the establishment numbers and check whether it has any effect on the likelihood of successful actions. As the figure 4, we find that the likelihood of successful responses exhibits a positive correlation (0.27) with the proportion of employee numbers in each establishment. As the the proportion increases, these local authorities are more likely to successfully respond to enforcement actions.

```{r, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Figure 4. The relatioinship between the proportion of employee numbers in each establishment and successful actions percentage."}
# Visualise to check the relationship
ggplot(percent_prop_employee, aes(x=percentage_of_responses, y = prop_employee)) + geom_point() + labs(x="Percentage of Successful Responses", y="Proportion of FTE Food Safety Employees", title='The relatioinship between employee proportion and successful actions percentage.', subtitle="Each point is a Local Authority. The shaded area shows the 95% CI for the best-fitting regression line") + geom_smooth(formula = y ~ x, method=lm)
```

From the table 2, We can expect a 28.16 extra likelihood of successful responses for every extra proportion of the employees in establishments. Meanwhile, we can also expect likelihood of 78.94 in successful responses rate when the proportion is zero.

Table 2. The relationship between the employee proportion and successful actions percentage.

```{r, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Table 2. The relatioinship between the employee proportion and successful actions percentage."}
#Calculate regression coefficient using estimation approach
cbind(coefficient=coef(prop.success.by.prop.employee), confint(prop.success.by.prop.employee))
```


---

# Question 2

## Data Dictionary

Variables              | Description |
-----------------------|-------------|
sold by | Publishing or E-commerce company that sold the book |  
publisher.type | Type of publisher | 
genre | Genre of the book | 
avg.review | Average rating received for the book | 
daily.sales | Average number of sales (minus refunds) across all days in the period Total number of reviews received for the book | 
total.reviews | Average price for which the book sold across all sales in the period | 

## Section 1

```{r}
# Read the dataset
publisher_sales <- read_csv("publisher_sales.csv")

# Check the structure
str(publisher_sales)
```

```{r}
# Clean data and store in another dataframe
publisher_sales <- na.omit(publisher_sales)

# Change data type
column_f <- c("sold by", "publisher.type", "genre")
publisher_sales[column_f] <- lapply(publisher_sales[column_f], as.factor)

#Check the structure again
str(publisher_sales)
```

### Do books from different genres have different daily sales on average?
```{r}
#Test whether genre has a significant effect on daily sales
daily.sales.by.genre <- lm(daily.sales ~ genre, data = publisher_sales)
anova(daily.sales.by.genre)
```

```{r}
#Explain the difference
summary(daily.sales.by.genre)
```

```{r}
#Calculate estimated marginal means to get the means for each genre
daily.sales.by.genre.emm <- emmeans(daily.sales.by.genre, ~genre)
daily.sales.by.genre.emm
```

```{r}
#Do pairwise contrasts
daily.sales.by.genre.pairs <- confint(pairs(daily.sales.by.genre.emm))
daily.sales.by.genre.pairs
```

```{r}
#Visualisation
p.daily.sales <- ggplot(summary(daily.sales.by.genre.emm), aes(x=genre, y=emmean, ymin=lower.CL, ymax=upper.CL)) + geom_point() + geom_linerange() + labs(x="Book Genre", y="Daily Sales on Average", subtitle="Error Bars are Extent of 95% CIs")

p.contrasts <- ggplot(daily.sales.by.genre.pairs, aes(x=contrast, y=estimate, ymin=lower.CL, ymax=upper.CL)) + geom_point() + geom_linerange() + geom_hline(yintercept=0, lty=2) + labs(x="Contrast", y="Difference in Daily Sales", subtitle="Error Bars are Extent of 95% CIs") + theme(axis.text.x = element_text(angle = 15))

grid.arrange(p.daily.sales, p.contrasts, ncol = 2)
```

### Do books have more/fewer sales depending upon their average review scores and total number of reviews.
```{r}
#Test whether average review score and review numbers have a significant effect on daily sales
daily.sales.by.review.main <- lm(daily.sales ~ avg.review + total.reviews, data = publisher_sales)
summary(daily.sales.by.review.main)
```

```{r}
cbind(coef(daily.sales.by.review.main), confint(daily.sales.by.review.main))
```


```{r}
#Consider interaction between review score and review numbers
daily.sales.by.review.intr <- lm(daily.sales ~ avg.review * total.reviews, data = publisher_sales)
summary(daily.sales.by.review.intr)
```

```{r}
cbind(coef(daily.sales.by.review.intr), confint(daily.sales.by.review.intr))
```

```{r}
anova(daily.sales.by.review.main, daily.sales.by.review.intr)
```

```{r}
#Visualisation
sale.preds <- tibble(avg.review = unlist(expand.grid(seq(0, 5, 1), seq(0, 250, 5))[1]),
                         total.reviews = unlist(expand.grid(seq(0, 5, 1), seq(0, 250, 5))[2]))

sale.preds <- mutate(sale.preds,
                     sale.hat.main = predict(daily.sales.by.review.main, sale.preds),
                     sale.hat.intr = predict(daily.sales.by.review.intr, sale.preds))

p1 <- ggplot(sale.preds, aes(avg.review, total.reviews)) + geom_contour_filled(aes(z = sale.hat.main)) + guides(fill=guide_legend(title="Daily Sales"))

p2 <- ggplot(sale.preds, aes(avg.review, total.reviews)) + geom_contour_filled(aes(z = sale.hat.intr)) + guides(fill=guide_legend(title="Daily Sales"))

grid.arrange(p1, p2)
```




### What is the effect of sale price upon the number of sales, and is this different across genres?
```{r}
#Examine the effect of sale price upon book sales
daily.sales.by.price <- lm(daily.sales ~ sale.price, data = publisher_sales)
summary(daily.sales.by.price)
```

```{r}
#Examine the effect of sale price upon book sales across genre
daily.sales.by.price.main <- lm(daily.sales ~ sale.price + genre, data = publisher_sales)
summary(daily.sales.by.price.main)

#Consider interaction between sale price and genre
daily.sales.by.price.all <- lm(daily.sales ~ sale.price * genre, data = publisher_sales)
summary(daily.sales.by.price.all)
```

```{r}
#Use vif scores to check multicollinearity
vif(daily.sales.by.price.main)
```

```{r}
#Visualisation
p3 <- mutate(publisher_sales,
       main.hat = predict(daily.sales.by.price.main, publisher_sales),
       intr.hat = predict(daily.sales.by.price.all, publisher_sales)) %>%
ggplot() +
    geom_line(aes(sale.price, main.hat, colour = genre), linewidth = 1) +
  labs(y = "Prediction", subtitle = "Main Effects")

p4 <- mutate(publisher_sales,
       main.hat = predict(daily.sales.by.price.main, publisher_sales),
       intr.hat = predict(daily.sales.by.price.all, publisher_sales)) %>%
ggplot() +
    geom_line(aes(sale.price, intr.hat, colour = genre), linewidth = 1) +
  labs(y = "Prediction", subtitle = "Interaction Effects")

grid.arrange(p3, p4)
```



---

## Section 2

This report displays the analysis results requested by the management team of publishing company. In this report, we especially focus on the factors (genre, review numbers, review score and sale price) and discuss whether they are more likely to affect the book sales. The data used in this analysis is collected by the publishing company's sale records over a period of many months and expected to offer some insights to understand the key to growth in sales.

First of all, we take a look at the sales in different genres. We can see there are different average sales in different genres. From the table 2, the average sale of children genre is approximate 55.6. The fiction genre has a difference of 50.3 from children genre and reaches 105.9 in its average sale, while the non-fiction genre possesses a difference of around 20.3 and an average sale of 75.9.

Table: Table 3. The Average Sale and Difference in Each Genre.

Genre       | Difference | Estimated Marginal Mean |
------------|------------|-------------------------|
Children	  | 55.6		   | 55.6                    |
Fiction	    | 50.3		   | 105.9                   |
Non Fiction | 20.3		   | 75.9                    |

Digging deeper, we research on the difference between each genre, not only limited to compare with the children genre. The left panel of figure 5 states the mean daily book sale for each genre. The fiction genre has the highest average sales, followed by the non-fiction genre. Genre for children has the lowest average sales. The right panel shows the estimates of the difference in book sales for each pair of genres. 

1. The estimate for the Childrens-Fiction comparison shows a point estimate of 50.2 greater sales for the fiction genre, but the 95% CI spans 48.7 to 52 greater for the same genre. 
2. The estimate for the Childrens-NonFiction comparison sees a point estimate of 20.3 greater sales for the non-fiction genre, but the 95% CI spans 18.6 to 21.9 greater for the same genre. 
3. The estimate for the Fiction-NonFiction comparison exhibits a point estimate of 30 greater sales for the fiction genre, but the 95% CI spans 28.4 to 31.7 greater for the same genre.

```{r, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Figure.5 The relatioinship between average review scores, total reviews and book sales."}
#Visualisation
p.daily.sales <- ggplot(summary(daily.sales.by.genre.emm), aes(x=genre, y=emmean, ymin=lower.CL, ymax=upper.CL)) + geom_point() + geom_linerange() + labs(x="Book Genre", y="Daily Sales on Average", subtitle="Error Bars are Extent of 95% CIs")

p.contrasts <- ggplot(daily.sales.by.genre.pairs, aes(x=contrast, y=estimate, ymin=lower.CL, ymax=upper.CL)) + geom_point() + geom_linerange() + geom_hline(yintercept=0, lty=2) + labs(x="Contrast", y="Difference in Daily Sales", subtitle="Error Bars are Extent of 95% CIs") + theme(axis.text.x = element_text(angle = 15))

grid.arrange(p.daily.sales, p.contrasts, ncol = 2)
```

Next, we choose other two variables (average review score and total reviews)  to evaluate their impacts on book sales. From the table 4, we can see there are a negative and a positive correlations in review scores and total reviews respectively. The book sales decrease by 3.94 for every extra average review score, while the sales increase by 0.54  for every extra review. When considering the interaction between average scores and reviews, we can spot changes in both two variables. The interaction terms tell that each additional review increases the effectiveness of average review scores on book sales by 0.09.

Table: Table 4. The Average Review Scores, Total Reviews and Interaction.

Variables             | Coefficient | Coefficient with Interaction |
----------------------|-------------|------------------------------|
Average Review Scores	| -3.94		    | -13.68                       |
Total Reviews   	    | 0.54		    | 0.16                         |
Interaction     	    | N/A 		    | 0.09                         |

```{r, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Figure.6 Main Effect vs. Interaction Effect."}
sale.preds <- tibble(avg.review = unlist(expand.grid(seq(0, 5, 1), seq(0, 250, 5))[1]),
                         total.reviews = unlist(expand.grid(seq(0, 5, 1), seq(0, 250, 5))[2]))

sale.preds <- mutate(sale.preds,
                     sale.hat.main = predict(daily.sales.by.review.main, sale.preds),
                     sale.hat.intr = predict(daily.sales.by.review.intr, sale.preds))

p1 <- ggplot(sale.preds, aes(avg.review, total.reviews)) + geom_contour_filled(aes(z = sale.hat.main)) + guides(fill=guide_legend(title="Daily Sales"))

p2 <- ggplot(sale.preds, aes(avg.review, total.reviews)) + geom_contour_filled(aes(z = sale.hat.intr)) + guides(fill=guide_legend(title="Daily Sales"))

grid.arrange(p1, p2)
```

Finally, we evaluate the effect of sale price upon book sales. From table 5, the book sales decrease by 3.81 for every extra sale price. When considering book genres and their interactions, the book sales slightly decrease by 0.81 and 1.73 for every extra sale price, respectively. The figure 7 shows that there is a significant main effect of sale price upon book sales and of genres upon book sales. There is also a significant interaction effect between sale price and genres, with the positive effect of sale price being significantly larger when genres are present. For example, we can see the sale grows by 48.67 for every extra fiction book. Furthermore, the effect of sale price is different across genres. Each additional fiction book increases the effectiveness of sale price on book sales by 1.46, while every extra non-fiction book enhances the effectiveness of sale price on book sales by 1.28.

Table: Table 5. The Sale price, Genre and Interaction.

Variables                    | Coefficient | Coefficient with Genre | Coefficient with Interaction |
-----------------------------|-------------|------------------------|------------------------------|
Sale Price  	               | -3.81		   | -0.83                  | -1.73                        |
Genre: Children 	           | N/A 		     | 63.89                  | 72.88                        |
Genre: Fiction   	           | N/A 		     | 48.67                  | 35.2                         |
Genre: Non-Fiction   	       | N/A 		     | 15.56                  | 6.55                         |
Interaction 1 (Fiction)   	 | N/A 		     | N/A                    | 1.46                         |
Interaction 2 (Non-Fiction)  | N/A 		     | N/A                    | 1.28                         |

```{r, echo=FALSE, fig.align='center', out.width="60%", fig.cap="Figure.7 Main Effect vs. Interaction Effect."}
p3 <- mutate(publisher_sales,
       main.hat = predict(daily.sales.by.price.main, publisher_sales),
       intr.hat = predict(daily.sales.by.price.all, publisher_sales)) %>%
ggplot() +
    geom_line(aes(sale.price, main.hat, colour = genre), linewidth = 1) +
  labs(y = "Prediction", subtitle = "Main Effects")

p4 <- mutate(publisher_sales,
       main.hat = predict(daily.sales.by.price.main, publisher_sales),
       intr.hat = predict(daily.sales.by.price.all, publisher_sales)) %>%
ggplot() +
    geom_line(aes(sale.price, intr.hat, colour = genre), linewidth = 1) +
  labs(y = "Prediction", subtitle = "Interaction Effects")

grid.arrange(p3, p4)
```

---